#include "vmlinux.h"
#include "common.h"
#include <bpf/bpf_helpers.h>
#include <bpf/bpf_tracing.h>
#include <bpf/bpf_core_read.h>

char _license[] SEC("license") = "GPL";

struct {
    __uint(type, BPF_MAP_TYPE_RINGBUF);    // int (*name)[val];
    __uint(max_entries, 1 << 20); // 1MB (2^20)
} ringbuf_selfdel SEC(".maps");

SEC("lsm/path_unlink") // unlink() 함수 호출 시 발동
int BPF_PROG(path_unlink, const struct path *dir, struct dentry *dentry_arg) {
    /*
    파일이 삭제되면 (=unlink() 함수가 호출되면), 삭제된 파일과 삭제한 명령에 대한 정보를 Buffer로 전송.
    ex. rm test -> executable name: rm / bpf_get_current_comm: rm / 삭제된 current file: test
    */
   
    struct task_struct *task; // 실행 중인 프로세스에 대한 정보 (리눅스 기본 구조체)
    struct event_data *eventdata; // Detection 정보 출력을 위한 구조체 (커스텀 구조체)

    eventdata = bpf_ringbuf_reserve(&ringbuf_selfdel, sizeof(struct event_data), 0);
    // 1MB의 ringbuf 버퍼에서, 하나의 event_data 를 위한 메모리 공간 확보 & 시작 주소 반환
    if (!eventdata) { // 메모리 확보 실패
        return 0;
    }

    bpf_get_current_comm(&eventdata->comm, sizeof(eventdata->comm));
    // unlink() 호출한 (BPF 트리거한) 프로세스 이름 저장 | ex. rm test 인 경우, eventdata->comm == "rm"
    // 커널에서 데이터를 읽어서 eventData 변수에 저장

    task = bpf_get_current_task_btf(); // 실행중인 프로세스의 task_struct 구조체 데이터 가져오기

    bpf_probe_read_kernel_str(&eventdata->exename, sizeof(eventdata->exename), 
                        task->mm->exe_file->f_path.dentry->d_name.name);
    // 커널에서 데이터를 읽어오기
    // task 에서, 현재 프로세스의 실행 파일을 탐색 (exe_file)
    // 실행 파일의 이름을 가져오기 (ex. rm test -> rm 가져온다)
    // task (프로세스 정보) 에서 프로그램 이름을 읽어서 eventData 에 기록함.

    bpf_probe_read_kernel_str(&eventdata->filename, sizeof(eventdata->filename),
                        dentry_arg->d_name.name);
    // 커널에서 데이터를 읽어오기
    // dentry: Command 의 파라미터를 의미함. ex. rm test (dentry_arg -> d_name.name)
    // Command 파라미터를 읽어서 eventData 에 기록함.

    eventdata->pid = bpf_get_current_pid_tgid() >> 32; // PID 추출
    // bpf_get_current_pid_tgid(): 64Bit 정수 반환, (상위 32Bit: TGID, 하위 32Bit: PID)
    // 상위 32Bit 추출
    eventdata->ppid = task->real_parent->tgid;
    // 부모 프로세스의 TGID (대부분 TGID == PID)
    eventdata->uid = bpf_get_current_uid_gid() & 0xFFFFFFFF;
    // bpf_get_current_uid_gid(): 현재 사용자의 UID, GID 반환 (상위 32Bit: GID, 하위 32Bit: UID)
    // 하위 32Bit 추출 (UID)

    /* 
    eventData 변수에 데이터 저장 완료 (=ringbuf 쓰기 완료)
    */

    bpf_printk("--------------------------------------------%s\n", " ");
    bpf_printk("Current file is being deleted value: %s\n", eventdata->filename);
    bpf_printk("Current executable name: %s\n", eventdata->exename);
    bpf_printk("Current command using bpf_get_current_comm: %s\n", eventdata->comm);
    bpf_printk("Current UID: %d\n", eventdata->uid);
    bpf_printk("Current PID: %d\n", eventdata->pid);
    bpf_printk("Current PID: %d\n", eventdata->ppid);
    bpf_printk("--------------------------------------------%s\n", " ");

    bpf_ringbuf_submit(eventdata, 0);
    // ringbuf 의 내용을 로더로 전송

    return 0;
}